---
- name: Configure ServiceNow ITSM Credential Type in AAP
  hosts: localhost
  connection: local
  gather_facts: false
  collections:
    - infra.aap_configuration

  vars:
    # Supply these via env vars or extra_vars when running
    aap_hostname: "{{ lookup('env', 'AAP_HOSTNAME') | default(omit) }}"
    aap_token: "{{ lookup('env', 'AAP_TOKEN') | default(omit) }}"
    aap_validate_certs: "{{ (lookup('env', 'AAP_VALIDATE_CERTS') | default('true')) | bool }}"

    # Define the credential type to create in Controller
    controller_credential_types:
      - name: "ServiceNow ITSM Credential"
        description: "Description of your credential type"
        kind: "cloud"
        inputs:
          fields:
            - id: instance
              type: string
              label: Instance
            - id: username
              type: string
              label: Username
            - id: password
              type: string
              label: Password
              secret: true
          required:
            - instance
            - username
            - password
        injectors:
          env:
            SN_HOST: !unsafe "{{ instance }}"
            SN_USERNAME: !unsafe "{{ username }}"
            SN_PASSWORD: !unsafe "{{ password }}"

    # Create the same custom credential type in Event-Driven Ansible (EDA)
    eda_credential_types:
      - name: "ServiceNow ITSM Credential"
        description: "Description of your credential type"
        inputs:
          fields:
            - id: instance
              type: string
              label: Instance
            - id: username
              type: string
              label: Username
            - id: password
              type: string
              label: Password
              secret: true
          required:
            - instance
            - username
            - password
        injectors:
          env:
            SN_HOST: !unsafe "{{ instance }}"
            SN_USERNAME: !unsafe "{{ username }}"
            SN_PASSWORD: !unsafe "{{ password }}"

  roles:
    - role: infra.aap_configuration.dispatch
      # Optionally restrict dispatcher to only credential_types
      # vars:
      #   aap_configuration_dispatcher_roles:
      #     - credential_types
      #     - eda_credential_types


